============================================
  语音合成功能修复说明
============================================

问题: 语音合成失败，提示 "请安装 dashscope"
时间: 2025-11-24

✅ 已修复的问题
============================================

1. 导入路径错误
   
   错误: from dashscope.audio.tts_v2 import SpeechSynthesizer
   正确: from dashscope import SpeechSynthesizer
   
   原因: dashscope 1.14.0 版本中，SpeechSynthesizer 
         直接在 dashscope 模块下，不在 audio.tts_v2 子模块

2. 添加了详细的错误日志
   
   现在会显示完整的异常堆栈信息
   方便排查问题

3. 添加了 API Key 检查
   
   如果未配置 COSYVOICE_APPKEY
   会提示警告而不是报错


🔧 修改的文件
============================================

1. audio/qa_audio.py
   • 修复了 dashscope 导入路径
   • 添加了 API Key 检查
   • 增强了错误日志

2. API配置说明.txt
   • 添加了 CosyVoice 配置说明

3. test_cosyvoice.py (新增)
   • 完整的测试脚本
   • 测试导入、配置、初始化、文本生成、语音合成

4. 测试语音合成.bat (新增)
   • 一键运行测试脚本


📋 验证修复
============================================

方式 1: 运行测试脚本
--------------------------------------------

双击运行: 测试语音合成.bat

这将测试:
  ✓ dashscope 导入
  ✓ 配置检查
  ✓ 系统初始化
  ✓ 文本生成
  ✓ 语音合成


方式 2: 重启服务器测试
--------------------------------------------

1. 停止当前服务器 (Ctrl+C)

2. 重新启动
   start_predict_server.bat

3. 访问语音问答页面
   http://localhost:5000/web/qa_audio.html

4. 输入问题并提交
   例如: "如何预防心血管疾病？"

5. 查看结果
   • 应该显示文本回答
   • 如果配置了 CosyVoice API Key，还会显示音频播放器


📊 预期结果
============================================

场景 1: 只配置了 DeepSeek API Key
--------------------------------------------

启动日志:
  ✓ DeepSeek LLM 初始化成功
  ⚠️ COSYVOICE_APPKEY 未配置，语音合成功能不可用

功能:
  ✓ 文本问答正常
  ✗ 语音合成不可用

前端显示:
  ✓ 显示文本回答
  ✗ 不显示音频播放器


场景 2: 配置了 DeepSeek 和 CosyVoice API Key
--------------------------------------------

启动日志:
  ✓ DeepSeek LLM 初始化成功
  ✓ CosyVoice TTS 初始化成功

功能:
  ✓ 文本问答正常
  ✓ 语音合成正常

前端显示:
  ✓ 显示文本回答
  ✓ 显示音频播放器


⚠️ 注意事项
============================================

1. CosyVoice API Key 获取
   
   访问: https://help.aliyun.com/zh/model-studio/get-api-key
   注册阿里云百炼账号
   获取 API Key
   
   免费额度:
   • 2025年11月15日前开通: 2000字符
   • 2025年11月15日后开通: 10000字符
   • 有效期: 开通后90天

2. 配置 API Key
   
   方式 1: 运行 配置API_KEY.bat
   方式 2: 手动编辑 .env 文件
   
   在 .env 文件中添加:
   COSYVOICE_APPKEY=your_api_key_here

3. 文本长度限制
   
   单次合成文本不得超过 2000 字符
   系统会自动处理长文本

4. 音色选择
   
   当前使用: longxiaochun (默认音色)
   可选音色: 参见阿里云文档
   https://help.aliyun.com/zh/model-studio/cosyvoice-voice-list


🔍 故障排查
============================================

问题 1: 仍然提示 "请安装 dashscope"
--------------------------------------------

解决:
1. 确认 dashscope 已安装
   D:\software\Anaconda\envs\cardioenv\python.exe -m pip list | findstr dashscope

2. 如果未安装，运行
   install_dependencies.bat

3. 或手动安装
   pip install dashscope -i https://pypi.tuna.tsinghua.edu.cn/simple


问题 2: 语音合成失败，提示 API Key 错误
--------------------------------------------

解决:
1. 检查 .env 文件是否存在
2. 检查 COSYVOICE_APPKEY 是否正确
3. 重启服务器


问题 3: 音频无法播放
--------------------------------------------

解决:
1. 检查 static/audio/ 目录是否存在
2. 检查音频文件是否生成
3. 检查浏览器控制台是否有错误
4. 尝试使用其他浏览器


📝 相关文档
============================================

• README.md - 项目总览
• API配置说明.txt - API Key 配置详解
• 使用说明.txt - 快速上手
• 立即开始.txt - 快速开始指南
• 语音合成CosyVoice Python SDK.md - 官方文档


🎯 快速修复流程
============================================

1. 运行测试
   测试语音合成.bat
   ↓
2. 查看测试结果
   如果失败，按提示操作
   ↓
3. 配置 API Key（如需要）
   配置API_KEY.bat
   ↓
4. 重启服务器
   start_predict_server.bat
   ↓
5. 测试功能
   http://localhost:5000/web/qa_audio.html


============================================
  修复完成！现在可以使用语音合成功能了
============================================

如果只配置了 DeepSeek API Key:
  ✓ 文本问答功能可用
  ✗ 语音合成功能不可用

如果同时配置了 DeepSeek 和 CosyVoice:
  ✓ 文本问答功能可用
  ✓ 语音合成功能可用

建议: 先测试文本问答功能
      确认正常后再配置语音合成

