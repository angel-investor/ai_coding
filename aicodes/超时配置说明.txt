============================================
  CosyVoice 超时配置说明
============================================

日期: 2025-11-24


🔧 优化内容
============================================

1. ✅ 增加超时时间
   • 从 5 秒增加到 30 秒
   • 可通过环境变量自定义

2. ✅ 添加重试机制
   • 默认重试 3 次
   • 每次重试间隔 2 秒
   • 可通过环境变量自定义

3. ✅ 详细日志输出
   • 记录每次尝试的结果
   • 显示超时和重试配置
   • 便于问题排查


⚙️ 配置参数
============================================

1. COSYVOICE_TIMEOUT（超时时间）
   • 默认值: 30 秒
   • 说明: WebSocket 连接和数据传输的超时时间
   • 建议值: 20-60 秒

2. COSYVOICE_MAX_RETRIES（最大重试次数）
   • 默认值: 3 次
   • 说明: 连接失败后的重试次数
   • 建议值: 2-5 次


📝 配置方法
============================================

方法 1: 使用默认配置（推荐）
--------------------------------------------

不做任何修改，系统会使用默认值:
  • 超时: 30 秒
  • 重试: 3 次

这对大多数场景已经足够。


方法 2: 通过 .env 文件配置
--------------------------------------------

编辑项目根目录的 .env 文件，添加或修改:

# 设置超时时间为 60 秒
COSYVOICE_TIMEOUT=60

# 设置最大重试次数为 5 次
COSYVOICE_MAX_RETRIES=5

保存后重启服务器生效。


方法 3: 运行配置脚本
--------------------------------------------

1. 运行: 配置API_KEY.bat
   
   这会自动创建 .env 文件，包含默认配置

2. 手动编辑 .env 文件调整参数

3. 重启服务器


🎯 推荐配置
============================================

场景 1: 网络状况良好
--------------------------------------------

COSYVOICE_TIMEOUT=20
COSYVOICE_MAX_RETRIES=2

说明: 快速响应，减少等待时间


场景 2: 网络状况一般（默认配置）
--------------------------------------------

COSYVOICE_TIMEOUT=30
COSYVOICE_MAX_RETRIES=3

说明: 平衡响应速度和成功率


场景 3: 网络状况较差
--------------------------------------------

COSYVOICE_TIMEOUT=60
COSYVOICE_MAX_RETRIES=5

说明: 增加成功率，但响应较慢


场景 4: 快速测试（不需要语音）
--------------------------------------------

COSYVOICE_TIMEOUT=10
COSYVOICE_MAX_RETRIES=1

说明: 快速失败，只返回文本


📊 工作流程
============================================

1. 第一次尝试
   ↓
   等待 30 秒（或配置的超时时间）
   ↓
   成功 → 返回音频
   失败 → 继续

2. 等待 2 秒后重试
   ↓
   第二次尝试
   ↓
   等待 30 秒
   ↓
   成功 → 返回音频
   失败 → 继续

3. 等待 2 秒后重试
   ↓
   第三次尝试
   ↓
   等待 30 秒
   ↓
   成功 → 返回音频
   失败 → 仅返回文本


⏱️ 时间估算
============================================

使用默认配置（30秒超时，3次重试）:

• 最快: 立即成功（< 5 秒）
• 一般: 第一次成功（5-30 秒）
• 较慢: 重试一次成功（32-62 秒）
• 最慢: 所有尝试失败（约 98 秒）

注意: 即使语音合成失败，文本回答仍会正常返回


🔍 日志示例
============================================

成功示例:
--------------------------------------------

2025-11-24 16:25:08 - audio - INFO - 合成语音，文本长度: 118
2025-11-24 16:25:08 - audio - INFO - 超时设置: 30秒, 最大重试: 3次
2025-11-24 16:25:08 - audio - INFO - 语音合成尝试 1/3
2025-11-24 16:25:12 - audio - INFO - 音频合成成功: /static/audio/xxx.wav
2025-11-24 16:25:12 - audio - INFO - Request ID: xxx-xxx-xxx
2025-11-24 16:25:12 - audio - INFO - 首包延迟: 500ms


失败重试示例:
--------------------------------------------

2025-11-24 16:25:08 - audio - INFO - 合成语音，文本长度: 118
2025-11-24 16:25:08 - audio - INFO - 超时设置: 30秒, 最大重试: 3次
2025-11-24 16:25:08 - audio - INFO - 语音合成尝试 1/3
2025-11-24 16:25:38 - audio - WARNING - 第 1 次尝试超时: ...
2025-11-24 16:25:38 - audio - INFO - 准备重试...
2025-11-24 16:25:40 - audio - INFO - 语音合成尝试 2/3
2025-11-24 16:25:45 - audio - INFO - 音频合成成功: /static/audio/xxx.wav


全部失败示例:
--------------------------------------------

2025-11-24 16:25:08 - audio - INFO - 合成语音，文本长度: 118
2025-11-24 16:25:08 - audio - INFO - 超时设置: 30秒, 最大重试: 3次
2025-11-24 16:25:08 - audio - INFO - 语音合成尝试 1/3
2025-11-24 16:25:38 - audio - WARNING - 第 1 次尝试超时: ...
2025-11-24 16:25:38 - audio - INFO - 准备重试...
2025-11-24 16:25:40 - audio - INFO - 语音合成尝试 2/3
2025-11-24 16:26:10 - audio - WARNING - 第 2 次尝试超时: ...
2025-11-24 16:26:10 - audio - INFO - 准备重试...
2025-11-24 16:26:12 - audio - INFO - 语音合成尝试 3/3
2025-11-24 16:26:42 - audio - ERROR - 语音合成失败：已达到最大重试次数 3
2025-11-24 16:26:42 - audio - WARNING - 语音合成失败，仅返回文本


⚠️ 注意事项
============================================

1. 超时时间不要设置太短
   • 建议最少 20 秒
   • 太短可能导致正常请求也超时

2. 重试次数不要设置太多
   • 建议最多 5 次
   • 太多会导致用户等待时间过长

3. 即使语音合成失败，文本功能仍正常
   • 用户仍能看到文本回答
   • 只是没有音频播放

4. 修改配置后需要重启服务器
   • 停止当前服务器（Ctrl+C）
   • 重新运行 start_predict_server.bat


🔧 故障排查
============================================

问题 1: 总是超时
--------------------------------------------

解决方案:
1. 增加超时时间到 60 秒
2. 检查网络连接
3. 检查防火墙设置
4. 验证 API Key 是否有效


问题 2: 重试太多次，等待时间长
--------------------------------------------

解决方案:
1. 减少重试次数到 2 次
2. 减少超时时间到 20 秒
3. 如果不需要语音，可以在代码中禁用语音合成


问题 3: 偶尔成功，偶尔失败
--------------------------------------------

解决方案:
1. 保持默认配置（30秒，3次重试）
2. 这是正常现象，重试机制会自动处理
3. 查看日志确认重试是否生效


📝 完整配置示例
============================================

.env 文件内容:
--------------------------------------------

# DeepSeek API Configuration
DEEPSEEK_API_KEY=sk-52e226ac3cac46838cb282b45b1a648e
DEEPSEEK_API_URL=https://api.deepseek.com/v1
MODEL=deepseek-chat

# CosyVoice Configuration
COSYVOICE_APPKEY=your_cosyvoice_appkey_here
COSYVOICE_TOKEN=your_cosyvoice_token_here
COSYVOICE_TIMEOUT=30
COSYVOICE_MAX_RETRIES=3

# Model Configuration
MODEL_PATH=./model/xgb_model.pkl
DATA_PATH=D:/project/workspace/ai_coding/data/心血管疾病.xlsx

# Flask Configuration
FLASK_HOST=0.0.0.0
FLASK_PORT=5000
FLASK_DEBUG=False

# Logging Configuration
LOG_LEVEL=INFO
LOG_DIR=./logs


✅ 测试新配置
============================================

1. 修改 .env 文件中的参数

2. 重启服务器
   start_predict_server.bat

3. 访问页面
   http://localhost:5000/web/qa_audio.html

4. 输入问题并提交

5. 查看日志输出
   观察超时设置和重试过程


============================================
  现在系统更加稳定可靠了！
============================================

优势:
  ✓ 超时时间更长，成功率更高
  ✓ 自动重试，网络抖动也能成功
  ✓ 详细日志，方便问题排查
  ✓ 可配置，适应不同网络环境
  ✓ 即使失败，文本功能仍正常

建议:
  • 先使用默认配置测试
  • 根据实际情况调整参数
  • 查看日志了解运行状态

